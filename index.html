<!--
  📦 模組：社畜解放卡
  🕒 最後更新：2025-06-14T04:08:54+08:00
  🧑‍💻 作者/更新者：@s123104
  🔢 版本：v1.4.0
  📝 摘要：Improve chart updates, mobile quotes and iOS prompt
-->
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />

    <!-- SEO: 基本 Meta 標籤 -->
    <title>社畜解放卡 - 你的職場生存壓力計</title>
    <meta
      name="description"
      content="記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析、數據匯出與 AI 洞察，是你最佳的職場壓力管理工具。"
    />
    <meta
      name="keywords"
      content="社畜解放卡, 離職, 集點卡, 職場壓力, 工作心情, 厭世, 加班, 慣老闆, PWA, 前端工具, AI分析"
    />
    <link rel="canonical" href="https://github.com/s123104/work-freedom-card" />

    <!-- SEO: Open Graph (for Facebook, LinkedIn, etc.) -->
    <meta property="og:title" content="社畜解放卡 - 你的職場生存壓力計" />
    <meta
      property="og:description"
      content="記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析與 AI 洞察。"
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://github.com/s123104/work-freedom-card"
    />
    <meta
      property="og:image"
      content="https://s123104.github.io/web/og-image.png"
    />
    <!-- 建議您在此路徑放置一張 1200x630 的預覽圖 -->
    <meta property="og:site_name" content="社畜解放卡" />
    <meta property="og:locale" content="zh_TW" />

    <!-- SEO: Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="社畜解放卡 - 你的職場生存壓力計" />
    <meta
      name="twitter:description"
      content="記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析與 AI 洞察。"
    />
    <meta
      name="twitter:image"
      content="https://s123104.github.io/web/og-image.png"
    />
    <!-- 建議您在此路徑放置一張適合 Twitter 的預覽圖 -->

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3da35d" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="社畜解放卡" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <link rel="icon" type="image/png" href="icon-192.png" />
    <link rel="manifest" href="./manifest.json" />

    <!-- SEO: JSON-LD Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "社畜解放卡",
        "description": "記錄每日職場心情與鳥事，集滿離職點數，邁向自由！提供厭世指數分析、數據匯出與 AI 洞察，是你最佳的職場壓力管理工具。",
        "applicationCategory": "ProductivityApplication",
        "operatingSystem": "Web",
        "url": "https://github.com/s123104/work-freedom-card",
        "offers": { "@type": "Offer", "price": "0" },
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "4.9",
          "reviewCount": "258"
        }
      }
    </script>

    <!-- Tailwind CSS -->
    <script>
      // 內嵌 Tailwind CSS 以避免 CDN 警告
      (function() {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.tailwindcss.com/3.3.3/tailwind.min.css';
        document.head.appendChild(link);
      })();
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <!-- Google Fonts & Font Awesome Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Kalam:wght@400;700&family=Caveat:wght@400;600;700&family=Dancing+Script:wght@400;600;700&family=Indie+Flower&family=Shadows+Into+Light&family=Amatic+SC:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9f4",
                100: "#dcf4e4",
                200: "#bbe8cc",
                300: "#8cd5a8",
                400: "#5bb97d",
                500: "#3da35d",
                600: "#2d8049",
                700: "#26663d",
                800: "#215233",
                900: "#1d432b",
              },
              secondary: {
                50: "#fefce8",
                100: "#fef9c3",
                200: "#fef08a",
                300: "#fde047",
                400: "#facc15",
                500: "#eab308",
                600: "#ca8a04",
                700: "#a16207",
                800: "#854d0e",
                900: "#713f12",
              },
              accent: {
                50: "#fdf2f8",
                100: "#fce7f3",
                200: "#fbcfe8",
                300: "#f9a8d4",
                400: "#f472b6",
                500: "#ec4899",
                600: "#db2777",
                700: "#be185d",
                800: "#9d174d",
                900: "#831843",
              },
              neutral: {
                50: "#fafafa",
                100: "#f5f5f5",
                200: "#e5e5e5",
                300: "#d4d4d4",
                400: "#a3a3a3",
                500: "#737373",
                600: "#525252",
                700: "#404040",
                800: "#262626",
                900: "#171717",
              },
            },
            fontFamily: {
              sans: ["Noto Sans TC", "sans-serif"],
              "handwrite-1": ["Kalam", "cursive"],
              "handwrite-2": ["Caveat", "cursive"],
              "handwrite-3": ["Dancing Script", "cursive"],
              "handwrite-4": ["Indie Flower", "cursive"],
              "handwrite-5": ["Shadows Into Light", "cursive"],
              "handwrite-6": ["Amatic SC", "cursive"],
            },
            animation: {
              "bounce-in":
                "bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)",
              "fade-in": "fadeIn 1s ease-out",
              "slide-up": "slideUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94)",
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              wiggle: "wiggle 1s ease-in-out infinite",
              float: "float 6s ease-in-out infinite",
              glow: "glow 2s ease-in-out infinite alternate",
              "quote-slide":
                "quoteSlide 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)",
              "quote-fade": "quoteFade 0.6s ease-out",
              "feedback-pop": "feedbackPop 2s ease-out forwards",
            },
          },
        },
      };
    </script>

    <style>
      * {
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      input,
      textarea {
        -webkit-user-select: text;
        user-select: text;
      }
      .hidden {
        display: none;
      }

      @keyframes bounceIn {
        0% {
          opacity: 0;
          transform: scale(0.3) translateY(50px);
        }
        30% {
          opacity: 0.9;
          transform: scale(1.1);
        }
        60% {
          opacity: 1;
          transform: scale(0.89);
        }
        80% {
          transform: scale(1.05);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(60px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(100px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes wiggle {
        0%,
        7% {
          transform: rotateZ(0);
        }
        15% {
          transform: rotateZ(-15deg);
        }
        20% {
          transform: rotateZ(10deg);
        }
        25% {
          transform: rotateZ(-10deg);
        }
        30% {
          transform: rotateZ(6deg);
        }
        35% {
          transform: rotateZ(-4deg);
        }
        40%,
        100% {
          transform: rotateZ(0);
        }
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }
      @keyframes quoteSlide {
        from {
          opacity: 0;
          transform: translateY(-50px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      @keyframes feedbackPop {
        0% {
          opacity: 1;
          transform: translate(-50%, -50%) scale(0.5);
        }
        50% {
          transform: translate(-50%, -150%) scale(1.2);
        }
        100% {
          opacity: 0;
          transform: translate(-50%, -250%) scale(1.5);
        }
      }

      /* 粒子動畫 */
      @keyframes particleFade {
        0% {
          opacity: 1;
          transform: scale(1);
        }
        100% {
          opacity: 0;
          transform: scale(0);
        }
      }

      @keyframes collectPoint {
        0% {
          transform: translate(0, 0) scale(1);
        }
        50% {
          transform: translate(0, -100px) scale(1.5);
        }
        100% {
          transform: translate(0, 0) scale(1);
        }
      }

      /* 煙火動畫 */
      @keyframes firework {
        0% {
          transform: translate(-50%, 100vh);
          opacity: 1;
        }
        50% {
          transform: translate(-50%, 40vh);
          opacity: 1;
        }
        75% {
          transform: translate(-50%, 30vh);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, 30vh);
          opacity: 0;
        }
      }

      @keyframes explosion {
        0% {
          width: 4px;
          height: 4px;
          opacity: 1;
        }
        100% {
          width: 300px;
          height: 300px;
          opacity: 0;
        }
      }

      .firework {
        position: fixed;
        bottom: 0;
        left: 50%;
        width: 4px;
        height: 4px;
        border-radius: 50%;
        animation: firework 1.5s ease-out forwards;
        z-index: 9999;
      }

      .explosion {
        position: absolute;
        top: 0;
        left: 0;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 4px;
        border-radius: 50%;
        animation: explosion 1.5s ease-out forwards;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 1) 0%,
          rgba(255, 200, 0, 0.8) 100%
        );
        z-index: 9999;
      }

      .particle {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
        animation: particleFade 1s ease-out forwards;
        z-index: 100;
      }

      .grid-cell {
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        position: relative;
        overflow: hidden;
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid #e5e7eb;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        min-height: 40px;
      }
      .grid-cell:hover {
        transform: scale(1.08) translateY(-3px);
        box-shadow: 0 12px 35px rgba(61, 163, 93, 0.2);
        border-color: #3da35d;
        z-index: 10;
      }
      .grid-cell.filled {
        background: linear-gradient(145deg, #dcf4e4 0%, #bbe8cc 100%);
        border-color: #3da35d;
        box-shadow: 0 4px 15px rgba(61, 163, 93, 0.15);
      }
      .grid-cell.mood-money {
        background: linear-gradient(145deg, #fef9c3, #fde047);
        border-color: #ca8a04;
      }
      .grid-cell.mood-burnout {
        background: linear-gradient(145deg, #fecaca, #fca5a5);
        border-color: #ef4444;
      }
      .grid-cell.mood-annoying {
        background: linear-gradient(145deg, #e0e7ff, #c7d2fe);
        border-color: #6366f1;
      }
      .grid-cell.mood-stuck {
        background: linear-gradient(145deg, #e5e5e5, #d4d4d4);
        border-color: #737373;
      }
      .grid-cell.long-pressing {
        transform: scale(0.95);
        box-shadow: inset 0 4px 12px rgba(61, 163, 93, 0.2);
      }
      .date-text {
        color: #2d8049;
        font-weight: 700;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        transform: rotate(-2deg);
      }
      .grid-cell.mood-money .date-text {
        color: #a16207;
      }
      .grid-cell.mood-burnout .date-text {
        color: #b91c1c;
      }
      .grid-cell.mood-annoying .date-text {
        color: #4338ca;
      }
      .grid-cell.mood-stuck .date-text {
        color: #525252;
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .quote-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 24px;
        margin-top: 1.5rem;
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.3);
      }
      #quoteDisplay {
        display: none;
      }
      #quoteDisplay.show {
        display: flex;
      }
      @media (max-width: 768px) {
        #quoteDisplay {
          position: fixed;
          bottom: 10px;
          left: 0;
          right: 0;
          justify-content: center;
          z-index: 1100;
        }
        #quoteDisplay .quote-container {
          margin-top: 0;
          width: calc(100% - 2rem);
        }
      }
      .progress-ring {
        transform: rotate(-90deg);
      }
      .progress-ring-circle {
        transition: stroke-dasharray 0.5s ease-in-out;
      }

      .modal-backdrop {
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
      }
      .modal-content {
        background: white;
        border-radius: 24px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        transform: scale(0.9) translateY(20px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-open .modal-content {
        transform: scale(1) translateY(0);
      }

      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb {
        background: #3da35d;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #2d8049;
      }
      @media (max-width: 768px) {
        .stats-container,
        .analysis-container {
          display: block !important;
        }
        .stats-container > div,
        .analysis-container > div {
          margin-bottom: 1.5rem;
        }
        .grid-cell {
          min-height: 35px;
        }
      }

      /* Share & AI Modal Styles */
      .share-trigger {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        background-color: #3da35d;
        color: white;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
      }
      .share-trigger:hover {
        transform: scale(1.1);
        background-color: #2d8049;
      }
      .generic-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .generic-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .generic-modal .modal-box {
        background: #fff;
        border-radius: 16px;
        padding: 1.5rem;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        position: relative;
        text-align: center;
        transform: scale(0.95);
        transition: transform 0.3s;
      }
      .generic-modal.show .modal-box {
        transform: scale(1);
      }
      .generic-modal .close-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: transparent;
        border: none;
        font-size: 1.8rem;
        line-height: 1;
        cursor: pointer;
        color: #aaa;
      }
      #shareModal .share-options {
        margin: 1.5rem 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }
      #shareModal .share-btn {
        padding: 0.75rem;
        font-size: 0.9rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      #shareModal .share-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      #shareModal .share-btn--copy {
        background: #f3f3f3;
        color: #333;
      }
      #shareModal .share-btn--threads {
        background: #1c1c1c;
        color: #fff;
      }
      #shareModal .share-btn--twitter {
        background: #1da1f2;
        color: #fff;
      }
      #shareModal .share-btn--line {
        background: #00c300;
        color: #fff;
      }

      #aiExportModal #ai-prompt-output {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        width: 100%;
        min-height: 250px;
        font-family: monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* Annoyance Score Feedback */
      #annoyanceFeedback {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ef4444;
        font-size: 2.5rem;
        font-weight: bold;
        text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.3);
        pointer-events: none;
        z-index: 9999;
        animation: feedbackPop 2s ease-out forwards;
      }

      /* iOS PWA Install Prompt */
      #iosPwaModal .instruction-step {
        display: flex;
        align-items: center;
        text-align: left;
        margin-top: 1rem;
        padding: 0.75rem;
        background-color: #f3f4f6;
        border-radius: 8px;
      }
      #iosPwaModal .instruction-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
        color: #3b82f6;
        width: 30px;
        text-align: center;
      }

      /* 成就系統樣式 */
      .achievement {
        background: linear-gradient(145deg, #f8fafc, #e2e8f0);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .achievement-locked {
        filter: grayscale(1);
        opacity: 0.7;
      }

      .achievement-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 18px;
        color: white;
        flex-shrink: 0;
      }

      .achievement-content {
        flex-grow: 1;
      }

      .achievement-title {
        font-weight: 600;
        margin-bottom: 2px;
      }

      .achievement-description {
        font-size: 0.75rem;
        color: #64748b;
      }

      .achievement-locked .achievement-description:after {
        content: " (尚未解鎖)";
      }

      .achievement-unlocked-date {
        font-size: 0.7rem;
        color: #3da35d;
        margin-top: 2px;
      }

      .achievement-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #3da35d, #2d8049);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        display: flex;
        align-items: center;
        animation: slideDown 0.5s ease, fadeOut 0.5s ease 4.5s forwards;
        max-width: 90%;
      }

      @keyframes slideDown {
        from {
          transform: translate(-50%, -100px);
          opacity: 0;
        }
        to {
          transform: translate(-50%, 0);
          opacity: 1;
        }
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
          visibility: hidden;
        }
      }

      .achievement-notification-icon {
        font-size: 24px;
        margin-right: 12px;
      }

      .achievement-notification-content h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
      }

      .achievement-notification-content p {
        margin: 0;
        font-size: 14px;
        opacity: 0.9;
      }

      .mood-option {
        border-radius: 8px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: #f8fafc;
        margin-bottom: 8px;
      }
      
      .mood-option:hover {
        background-color: #f1f5f9;
        transform: translateY(-2px);
      }
      
      .mood-option.selected {
        background-color: #e2e8f0;
        border-left: 4px solid #3b82f6;
      }
      
      .mood-option i {
        font-size: 18px;
      }

      .animate-pop {
        animation: pop 0.5s ease-out;
      }
      
      @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }
      
      .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
        transform: scale(0);
        animation: ripple-effect 0.8s ease-out;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
      }
      
      @keyframes ripple-effect {
        0% { transform: scale(0); opacity: 1; }
        100% { transform: scale(2); opacity: 0; }
      }

      .mood-error {
        border: 2px solid #ef4444;
        border-radius: 8px;
        animation: pulse-error 1.5s infinite;
      }
      
      @keyframes pulse-error {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
      }
      
      .mood-error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        font-weight: 500;
        display: flex;
        align-items: center;
      }
    </style>
  </head>

  <body
    class="bg-gradient-to-br from-primary-50 via-white to-accent-50 min-h-screen font-sans overflow-x-hidden"
  >
    <!-- Annoyance Score Feedback Element -->
    <div id="annoyanceFeedback" class="hidden"></div>

    <!-- Background Elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
      <div
        class="absolute top-20 left-10 w-32 h-32 bg-primary-200 rounded-full opacity-20 animate-float"
      ></div>
      <div
        class="absolute bottom-20 right-20 w-24 h-24 bg-accent-200 rounded-full opacity-20 animate-float"
        style="animation-delay: -2s"
      ></div>
    </div>

    <!-- Header -->
    <header class="relative text-center py-6 sm:py-8 md:py-12 animate-fade-in">
      <div class="container mx-auto px-4">
        <h1
          class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl font-bold text-primary-800 mb-3 sm:mb-4 tracking-wide relative"
        >
          <span class="inline-block animate-wiggle">📋</span> 離職集點卡
          <span class="inline-block animate-pulse-slow">✨</span>
        </h1>
        <p
          class="text-base sm:text-lg md:text-xl text-primary-600 font-medium"
          id="progressText"
        >
          共100格，集滿離職
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pb-8">
      <!-- Grid Area -->
      <div
        class="glass-effect rounded-3xl shadow-2xl p-4 sm:p-6 md:p-8 mb-6 animate-slide-up"
      >
        <div class="text-center mb-4">
          <h2 class="text-xl sm:text-2xl font-bold text-primary-800 mb-2">
            <i class="fas fa-calendar-check mr-2"></i>我的離職集點進度
          </h2>
          <p class="text-primary-600 text-xs sm:text-sm">
            <i class="fas fa-info-circle mr-1"></i>短按標記日期，
            <span
              class="bg-primary-100 px-2 py-1 rounded-full font-bold animate-pulse"
              >長按記錄詳細事件</span
            >
          </p>
        </div>
        <div
          class="grid grid-cols-8 md:grid-cols-10 gap-1 sm:gap-2 max-w-4xl mx-auto"
          id="gridContainer"
        ></div>
        <!-- Quote Display (Moved here) -->
        <div id="quoteDisplay" class="hidden">
          <div
            class="quote-container text-center fixed bottom-4 left-4 right-4 z-10 bg-gradient-to-r from-green-700/90 to-green-600/90 p-4 rounded-lg shadow-lg transform transition-all duration-300 max-w-md mx-auto"
          >
            <i class="fas fa-quote-left text-2xl mb-4 opacity-70"></i>
            <p
              class="text-lg sm:text-xl font-handwrite-3 leading-relaxed mb-4"
              id="quoteText"
            ></p>
            <button
              onclick="hideQuote()"
              class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full text-sm transition-all duration-300"
            >
              <i class="fas fa-times mr-2"></i>收起
            </button>
          </div>
        </div>
      </div>

      <!-- Stats & Chart -->
      <div class="stats-container grid md:grid-cols-2 gap-4 mb-6">
        <div
          class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up"
          style="animation-delay: 0.2s"
        >
          <h3
            class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"
          >
            <i class="fas fa-chart-pie mr-2 text-primary-600"></i>進度統計
          </h3>
          <div class="flex items-center justify-center mb-4">
            <div class="relative w-24 h-24 sm:w-32 sm:h-32">
              <svg class="progress-ring w-full h-full" viewBox="0 0 120 120">
                <circle
                  cx="60"
                  cy="60"
                  r="54"
                  fill="none"
                  stroke="#e5e7eb"
                  stroke-width="8"
                />
                <circle
                  cx="60"
                  cy="60"
                  r="54"
                  fill="none"
                  stroke="#3da35d"
                  stroke-width="8"
                  stroke-linecap="round"
                  class="progress-ring-circle"
                  id="progressCircle"
                  stroke-dasharray="0 339.292"
                />
              </svg>
              <div
                class="absolute inset-0 flex items-center justify-center text-center"
              >
                <div>
                  <div
                    class="text-xl sm:text-2xl font-bold text-primary-700"
                    id="filledCount"
                  >
                    0
                  </div>
                  <div class="text-xs text-primary-600">已完成</div>
                </div>
              </div>
            </div>
          </div>
          <div class="space-y-2">
            <div class="flex justify-between items-center">
              <span class="text-sm text-neutral-600"
                ><i class="fas fa-coins mr-2 text-yellow-500"></i>錢途茫茫</span
              ><span class="font-semibold text-yellow-600" id="moodMoneyCount"
                >0</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-neutral-600"
                ><i class="fas fa-tired mr-2 text-red-500"></i>身心俱疲</span
              ><span class="font-semibold text-red-600" id="moodBurnoutCount"
                >0</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-neutral-600"
                ><i class="fas fa-angry mr-2 text-indigo-500"></i>鳥事一堆</span
              ><span
                class="font-semibold text-indigo-600"
                id="moodAnnoyingCount"
                >0</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-neutral-600"
                ><i class="fas fa-minus-circle mr-2 text-gray-500"></i
                >缺乏成長</span
              ><span class="font-semibold text-gray-600" id="moodStuckCount"
                >0</span
              >
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-neutral-600"
                ><i class="fas fa-percentage mr-2 text-accent-500"></i
                >完成率</span
              ><span class="font-semibold text-accent-600" id="completionRate"
                >0%</span
              >
            </div>
          </div>
          <div class="mt-6 space-y-2">
            <button
              onclick="openAiExportModal()"
              class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105"
            >
              <i class="fas fa-magic-wand-sparkles mr-2"></i>匯出至 AI 分析
            </button>
            <button
              onclick="openModal('achievementsModal'); renderAchievements();"
              class="w-full bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-600 hover:to-amber-700 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105"
            >
              <i class="fas fa-trophy mr-2"></i>查看離職成就
            </button>
            <button
              onclick="showClearConfirm()"
              class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105"
            >
              <i class="fas fa-trash-alt mr-2"></i>清空所有記錄
            </button>
          </div>
        </div>
        <div
          class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up"
          style="animation-delay: 0.4s"
        >
          <h3
            class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"
          >
            <i class="fas fa-chart-line mr-2 text-primary-600"></i>每日趨勢
          </h3>
          <div class="relative h-64"><canvas id="dailyChart"></canvas></div>
          <p class="mt-4 text-center text-primary-600 text-xs sm:text-sm">
            <i class="fas fa-sync-alt fa-spin mr-1"></i
            >圖表即時更新，反映最新集點狀態
          </p>
        </div>
      </div>

      <!-- Analysis & Records -->
      <div class="analysis-container grid md:grid-cols-2 gap-4 mb-6">
        <div
          class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up"
          style="animation-delay: 0.6s"
        >
          <h3
            class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"
          >
            <i class="fas fa-fire-alt mr-2 text-red-500"></i>厭世指數分析
          </h3>
          <div class="bg-red-50 p-6 rounded-2xl text-center">
            <div class="text-sm text-red-700 mb-2">總厭世指數</div>
            <div
              id="annoyanceIndexTotal"
              class="text-5xl font-bold text-red-600"
            >
              0
            </div>
            <p id="annoyanceLevel" class="text-red-500 font-semibold mt-2">
              內心毫無波瀾
            </p>
          </div>
          <div class="mt-4">
            <p class="text-sm text-neutral-600 mb-2 font-semibold">
              主要厭世來源：
            </p>
            <div
              id="topAnnoyanceKeywords"
              class="text-sm text-neutral-500 mb-3"
            >
              <div class="text-center py-4 text-neutral-500">尚無數據</div>
            </div>
            <div id="keywordsPagination" class="flex justify-center mt-2"></div>
          </div>

          <!-- 關鍵字雲區塊 -->
          <div class="mt-6">
            <p
              class="text-sm text-neutral-600 mb-2 font-semibold flex items-center"
            >
              <i class="fas fa-cloud mr-2 text-blue-400"></i>厭世關鍵字雲
            </p>
            <div
              id="keywordCloud"
              class="bg-blue-50 p-4 rounded-xl min-h-[120px] flex items-center justify-center flex-wrap"
            >
              <p class="text-neutral-500 text-center">
                尚無足夠數據生成關鍵字雲
              </p>
            </div>
          </div>
        </div>
        <div
          class="glass-effect rounded-2xl shadow-xl p-4 sm:p-6 animate-slide-up"
          style="animation-delay: 0.8s"
        >
          <h3
            class="text-lg sm:text-xl font-bold text-primary-800 mb-4 flex items-center"
          >
            <i class="fas fa-history mr-2 text-primary-600"></i>近期記錄
          </h3>
          <div id="recentRecords" class="space-y-3 max-h-64 overflow-y-auto">
            <p class="text-neutral-500 text-center py-8">
              <i class="fas fa-inbox text-3xl mb-2 block"></i>尚無記錄
            </p>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer
      class="text-center py-6 text-primary-600 animate-fade-in"
      style="animation-delay: 1s"
    >
      <p class="text-sm sm:text-base mb-3 font-handwrite-4">
        人生苦短，別浪費在不喜歡的地方。
      </p>
      <p class="text-xs opacity-75 mb-2">
        © 2025 離職集點卡. All Rights Reserved.
      </p>
      <p class="text-xs opacity-75 mb-4">
        <a href="https://github.com/s123104/work-freedom-card" class="underline hover:text-primary-700" target="_blank">
          MIT License 開源專案 by @s123104
        </a>
      </p>
    </footer>

    <!-- Share Button -->
    <button id="shareBtnTrigger" class="share-trigger" aria-label="分享此頁面">
      <i class="fas fa-share-alt"></i>
    </button>

    <!-- Share Modal -->
    <div id="shareModal" class="generic-modal" aria-hidden="true" role="dialog">
      <div class="modal-box">
        <button
          class="close-btn"
          aria-label="關閉"
          onclick="closeModal('shareModal')"
        >
          ×
        </button>
        <h3 class="text-xl font-bold">分享你的離職進度</h3>
        <p class="mt-2 text-gray-600">讓朋友一起見證你的自由之路！</p>
        <p id="shareAnnoyanceIndex" class="text-red-600 font-semibold mt-1"></p>
        <div class="share-options">
          <button id="copyLinkBtn" class="share-btn share-btn--copy">
            <i class="fas fa-copy"></i>複製文案
          </button>
          <button id="shareToThreadsBtn" class="share-btn share-btn--threads">
            <i class="fa-brands fa-threads"></i>Threads
          </button>
          <button id="shareToTwitterBtn" class="share-btn share-btn--twitter">
            <i class="fab fa-twitter"></i>Twitter
          </button>
          <button id="shareToLineBtn" class="share-btn share-btn--line">
            <i class="fab fa-line"></i>LINE
          </button>
        </div>
      </div>
    </div>

    <!-- AI Export Modal -->
    <div
      id="aiExportModal"
      class="generic-modal"
      aria-hidden="true"
      role="dialog"
    >
      <div class="modal-box" style="max-width: 600px">
        <button
          class="close-btn"
          aria-label="關閉"
          onclick="closeModal('aiExportModal')"
        >
          ×
        </button>
        <h3 class="text-xl font-bold mb-4 flex items-center justify-center">
          <i class="fas fa-magic-wand-sparkles mr-2 text-purple-500"></i>AI
          職涯分析師
        </h3>
        <p class="text-sm text-neutral-600 mb-4">
          已為您整合好 Prompt！點擊下方按鈕即可複製完整內容，直接貼到 GPT /
          Claude / Gemini 等任何 AI 聊天視窗中，開始您的職涯分析。
        </p>
        <textarea id="ai-prompt-output" readonly rows="10"></textarea>
        <button
          id="copyAIPromptBtn"
          class="w-full mt-4 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-4 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105"
        >
          <i class="fas fa-copy mr-2"></i>複製完整 Prompt
        </button>
      </div>
    </div>

    <!-- Event Modal -->
    <div
      id="eventModal"
      class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4"
    >
      <div class="modal-content p-6 sm:p-8 w-full max-w-lg">
        <h3 class="text-xl font-bold text-primary-800 mb-4 text-center">
          記錄厭世事件
        </h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2"
              >日期</label
            >
            <input
              type="date"
              id="eventDate"
              class="w-full border-gray-300 rounded-lg"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2"
              >心情 (離職四大原因)</label
            >
            <div id="moodSelector" class="space-y-2">
              <!-- 由 JavaScript 動態生成 -->
            </div>
            <div id="mood-error-message" class="mood-error-message hidden">
              <i class="fas fa-exclamation-circle mr-1"></i>
              請選擇一種心情分類！
            </div>
            <input type="hidden" id="selectedMood" value="" />
          </div>
          <div>
            <label
              for="eventDescription"
              class="block text-sm font-medium text-neutral-700 mb-2"
              >事件描述</label
            >
            <textarea
              id="eventDescription"
              rows="3"
              placeholder="今天發生了什麼鳥事？"
              class="w-full border-gray-300 rounded-lg"
            ></textarea>
            <div
              id="annoyanceFeedback"
              class="hidden mt-1 text-sm font-semibold text-red-500 animate-pulse"
            ></div>
          </div>
          <div>
            <label class="block text-sm font-medium text-neutral-700 mb-2"
              >爛事標籤</label
            >
            <div
              id="presetButtonsContainer"
              class="flex flex-wrap gap-2 mb-2"
            ></div>
            <div class="flex items-center gap-2">
              <div class="flex-grow relative">
                <input
                  type="text"
                  id="customPresetInput"
                  placeholder="新增自訂爛事"
                  class="w-full border-gray-300 rounded-lg pr-16"
                />
                <button
                  onclick="addCustomPreset()"
                  class="absolute right-0 top-0 bottom-0 bg-primary-500 text-white px-4 rounded-r-lg"
                >
                  新增
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex gap-3 mt-6">
          <button
            onclick="closeEventModal()"
            class="flex-1 bg-neutral-200 text-neutral-700 py-3 rounded-xl"
          >
            取消
          </button>
          <button
            onclick="saveEvent()"
            class="flex-1 bg-primary-500 text-white py-3 rounded-xl"
          >
            儲存
          </button>
        </div>
      </div>
    </div>

    <!-- Modals for Confirmation & PWA -->
    <div
      id="confirmModal"
      class="generic-modal"
      aria-hidden="true"
      role="dialog"
    >
      <div class="modal-box">
        <h3 class="text-xl font-bold">確認清空</h3>
        <p class="my-4">此操作無法復原，確定嗎？</p>
        <div class="flex gap-4">
          <button
            class="flex-1 bg-gray-200 py-2 rounded-lg"
            onclick="closeModal('confirmModal')"
          >
            取消</button
          ><button
            class="flex-1 bg-red-500 text-white py-2 rounded-lg"
            onclick="confirmClearAll()"
          >
            確認
          </button>
        </div>
      </div>
    </div>
    <div id="installPrompt" class="hidden"></div>
    <!-- Generic PWA prompt, now mainly for Android -->
    <div
      id="iosPwaModal"
      class="generic-modal"
      aria-hidden="true"
      role="dialog"
    >
      <div class="modal-box">
        <button
          class="close-btn"
          aria-label="關閉"
          onclick="handleIosPwaClose()"
        >
          ×
        </button>
        <h3 class="text-xl font-bold">加入主畫面</h3>
        <p class="mt-2 text-gray-600">
          將「社畜解放卡」加到主畫面，像 App 一樣體驗！
        </p>
        <div class="mt-4 bg-blue-50 p-4 rounded-lg">
          <h4 class="font-bold text-blue-700 mb-2">🚀 安裝好處</h4>
          <ul class="text-sm text-blue-800 space-y-1 list-disc pl-5">
            <li>無廣告、全螢幕使用體驗</li>
            <li>離線也能記錄心情</li>
            <li>一鍵開啟，方便快速</li>
          </ul>
        </div>
        <div class="mt-4 bg-yellow-50 p-4 rounded-lg">
          <h4 class="font-bold text-yellow-700 mb-2">📱 簡易安裝步驟</h4>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-2xl text-yellow-600">1</div>
            <div>
              點擊分享按鈕 <i class="fas fa-share-square text-blue-500"></i>
            </div>
          </div>
          <div class="flex items-center gap-3 mb-2">
            <div class="text-2xl text-yellow-600">2</div>
            <div>
              選擇「加入主畫面」<i
                class="fas fa-plus-square text-blue-500 ml-1"
              ></i>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-2xl text-yellow-600">3</div>
            <div>
              點擊「新增」完成！<i
                class="fas fa-check-circle text-green-500 ml-1"
              ></i>
            </div>
          </div>
        </div>
        <div class="mt-4 flex items-center justify-center gap-2">
          <input type="checkbox" id="iosPwaDontShow" class="w-4 h-4" />
          <label for="iosPwaDontShow" class="text-sm text-gray-600"
            >下次不再提醒</label
          >
        </div>
        <button
          class="w-full mt-4 bg-blue-500 text-white py-2 rounded-lg"
          onclick="handleIosPwaClose()"
        >
          我知道了
        </button>
      </div>
    </div>

    <!-- 成就系統 Modal -->
    <div
      id="achievementsModal"
      class="generic-modal"
      aria-hidden="true"
      role="dialog"
    >
      <div class="modal-box" style="max-width: 500px">
        <button
          class="close-btn"
          aria-label="關閉"
          onclick="closeModal('achievementsModal')"
        >
          ×
        </button>
        <h3 class="text-xl font-bold mb-4 flex items-center justify-center">
          <i class="fas fa-trophy mr-2 text-yellow-500"></i>離職成就系統
        </h3>
        <div class="text-sm text-neutral-600 mb-4 text-center">
          解鎖各種成就，記錄你的離職之路！
        </div>

        <div id="achievementsList" class="max-h-96 overflow-y-auto">
          <!-- 成就將由 JavaScript 動態生成 -->
        </div>
      </div>
    </div>

    <script>
      "use strict";
      // --- 全域變數 ---
      let deferredPrompt;
      let filledDates = new Map();
      let customPresets = [];
      let longPressTimer = null;
      let isLongPress = false;
      let currentCell = null;
      let dailyChart = null;
      let quoteTimer = null;
      let handwriteFonts = [
        "font-handwrite-1",
        "font-handwrite-2",
        "font-handwrite-3",
        "font-handwrite-4",
        "font-handwrite-5",
        "font-handwrite-6",
      ];
      let achievements = new Map();

      const STORAGE_KEY = "resignationCard_v5";
      const PRESETS_KEY = "resignationCard_presets_v2";
      const ACHIEVEMENTS_KEY = "resignationCard_achievements_v1";
      const TOTAL_CELLS = 100;

      function toLocalDateStr(date) {
        return date.toLocaleDateString("en-CA");
      }

      // --- 心情圖示 SVG ---
      const moodIcons = {
        money: `<svg viewBox="0 0 24 24" class="w-8 h-8 mx-auto stroke-current text-yellow-600"><path d="M9 10a1 1 0 11-2 0 1 1 0 012 0zm6 0a1 1 0 11-2 0 1 1 0 012 0zm-4 5a4 4 0 01-4-4h8a4 4 0 01-4 4zm4.5-8.5a1.5 1.5 0 00-3 0h3zm-4-3a.5.5 0 001 0h-1zM12 2a10 10 0 100 20 10 10 0 000-20z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>`,
        burnout: `<svg viewBox="0 0 24 24" class="w-8 h-8 mx-auto stroke-current text-red-600"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM9 15s1.5-2 3-2 3 2 3 2M9 9h.01M15 9h.01" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>`,
        annoying: `<svg viewBox="0 0 24 24" class="w-8 h-8 mx-auto stroke-current text-indigo-600"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM8 9l8 6M8 15L16 9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>`,
        stuck: `<svg viewBox="0 0 24 24" class="w-8 h-8 mx-auto stroke-current text-gray-600"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM9 12h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>`,
      };

      // --- 擴充後的厭世指數關鍵字庫 ---
      const annoyanceKeywords = new Map([
        // 強烈髒話 (10分)
        ["幹你娘", 10],
        ["操你媽", 10],
        ["機掰", 10],
        ["雞掰", 10],
        ["三小", 10],
        // 常見髒話 (8分)
        ["幹", 8],
        ["操", 8],
        ["靠", 8],
        ["靠杯", 8],
        ["靠北", 8],
        ["媽的", 8],
        ["媽蛋", 8],
        // 侮辱性詞彙 (7分)
        ["白痴", 7],
        ["智障", 7],
        ["腦殘", 7],
        ["低能", 7],
        ["廢物", 7],
        ["垃圾", 7],
        ["北七", 7],
        ["白癡", 7],
        // 職場負面行為 (6分)
        ["甩鍋", 6],
        ["推卸", 6],
        ["卸責", 6],
        ["畫大餅", 6],
        ["凹人", 6],
        ["壓榨", 6],
        ["慣老闆", 6],
        ["空降", 6],
        // 人物相關 (5分)
        ["老闆", 5],
        ["主管", 5],
        ["客戶", 5],
        ["老闆娘", 5],
        ["豬隊友", 5],
        ["小人", 5],
        ["機車", 5],
        ["雞歪", 5],
        ["無能", 5],
        // 工作內容 (4分)
        ["加班", 4],
        ["報告", 4],
        ["會議", 4],
        ["開會", 4],
        ["文件", 4],
        ["需求", 4],
        ["改來改去", 4],
        ["沒效率", 4],
        // 薪資與福利 (5分)
        ["薪水", 5],
        ["加薪", 5],
        ["年終", 5],
        ["分紅", 5],
        ["低薪", 5],
        ["沒錢", 5],
        // 情緒與狀態 (3分)
        ["不爽", 3],
        ["煩", 3],
        ["累", 3],
        ["壓力", 3],
        ["崩潰", 3],
        ["心累", 3],
        ["想死", 3],
        ["痛苦", 3],
        ["絕望", 3],
        ["沒意義", 3],
        ["無力", 3],
        ["倦怠", 3],
        ["鳥事", 3],
        ["爛", 3],
        ["瞎", 3],
        ["傻眼", 3],
        // 其他台灣常用語 (2-4分)
        ["搞事", 4],
        ["有事嗎", 3],
        ["三八", 2],
        ["哭喔", 3],
        ["是在哈囉", 2],
        ["炎上", 4],
        ["出包", 4],
        ["打槍", 4],
        ["銃康", 4],
      ]);

      // --- 初始化 ---
      function init() {
        loadData();
        loadPresets();
        loadAchievements();
        updateAllStats();
        initChart();
        setupListeners();
        setupPWA();
        setupRipple();
        generateGrid();
        renderMoodIcons();

        // 初始檢查成就
        checkAchievements();
      }

      document.addEventListener("DOMContentLoaded", () => {
        init();
      });

      // --- PWA & 核心功能 ---
      function checkAndShowPwaPrompt() {
        const isIOS =
          /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isInStandaloneMode =
          window.matchMedia("(display-mode: standalone)").matches ||
          window.navigator.standalone;
        const optOut = localStorage.getItem("iosPwaPromptOptOut");

        if (isIOS && !isInStandaloneMode && optOut !== "true") {
          if (!localStorage.getItem("iosPwaPromptShown")) {
            openModal("iosPwaModal");
            localStorage.setItem("iosPwaPromptShown", "true");
          }
        } else {
          // Android 或其他平台
          window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installPrompt = document.getElementById("installPrompt");
            installPrompt.classList.remove("hidden");
            installPrompt.onclick = installPWA;
          });
        }
      }
      async function installPWA() {
        if (deferredPrompt) deferredPrompt.prompt();
      }
      function handleIosPwaClose() {
        if (document.getElementById("iosPwaDontShow").checked) {
          localStorage.setItem("iosPwaPromptOptOut", "true");
        }
        closeModal("iosPwaModal");
      }
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register(
            URL.createObjectURL(
              new Blob([`self.addEventListener('fetch', () => {})`], {
                type: "application/javascript",
              })
            )
          )
          .catch((err) => console.error("SW registration failed", err));
      }

      // --- 資料處理 ---
      function loadData() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) filledDates = new Map(JSON.parse(saved).dates || []);
          const savedPresets = localStorage.getItem(PRESETS_KEY);
          customPresets = savedPresets
            ? JSON.parse(savedPresets)
            : ["開不完的會", "慣老闆", "豬隊友", "突發任務"];
        } catch (e) {
          console.error("載入資料失敗:", e);
        }
      }

      function saveData() {
        try {
          localStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({ dates: Array.from(filledDates.entries()) })
          );
          localStorage.setItem(PRESETS_KEY, JSON.stringify(customPresets));
        } catch (e) {
          console.error("儲存資料失敗:", e);
        }
      }

      // --- UI 生成與互動 ---
      function generateGrid() {
        const container = document.getElementById("gridContainer");
        container.innerHTML = "";

        for (let i = 0; i < TOTAL_CELLS; i++) {
          const cell = document.createElement("div");
          cell.className =
            "grid-cell aspect-square cursor-pointer flex items-center justify-center text-center relative";
          cell.dataset.index = i;

          // 設置長按和點擊事件
          cell.addEventListener("mousedown", (e) => startLongPress(e, i, cell));
          cell.addEventListener("touchstart", (e) => {
            e.preventDefault();
            startLongPress(e, i, cell);
          });
          cell.addEventListener("mouseup", endLongPress);
          cell.addEventListener("mouseleave", endLongPress);
          cell.addEventListener("touchend", endLongPress);
          cell.addEventListener("touchcancel", endLongPress);
          cell.addEventListener("click", () => handleCellClick(i, cell));

          container.appendChild(cell);
        }

        // 渲染已有數據
        filledDates.forEach((data, index) => {
          const cell = container.querySelector(`[data-index="${index}"]`);
          if (cell) fillCell(cell, data);
        });
      }

      function setupEventListeners() {
        document
          .getElementById("gridContainer")
          .addEventListener("pointerdown", handlePointerDown);
        document
          .getElementById("gridContainer")
          .addEventListener("pointerup", handlePointerUp);
        document
          .getElementById("gridContainer")
          .addEventListener("pointerleave", cancelLongPress);
        document
          .getElementById("shareBtnTrigger")
          .addEventListener("click", () => openModal("shareModal"));
        document
          .getElementById("quoteDisplay")
          .addEventListener("click", hideQuote);
      }

      function handlePointerDown(e) {
        if (!e.target.closest(".grid-cell")) return;
        const cell = e.target.closest(".grid-cell");
        const index = parseInt(cell.dataset.index, 10);
        isLongPress = false;
        currentCell = cell;
        cell.classList.add("long-pressing");

        // 添加視覺提示元素
        const ripple = document.createElement("div");
        ripple.className =
          "absolute inset-0 bg-primary-300 rounded-md opacity-0 scale-0 transition-all duration-800";
        ripple.style.transform = "scale(0)";
        ripple.style.opacity = "0";
        cell.appendChild(ripple);

        // 動畫效果
        setTimeout(() => {
          ripple.style.transform = "scale(0.8)";
          ripple.style.opacity = "0.3";
        }, 10);

        longPressTimer = setTimeout(() => {
          isLongPress = true;
          cell.classList.remove("long-pressing");
          // 長按完成後移除視覺提示
          if (ripple && ripple.parentNode) {
            ripple.style.transform = "scale(1)";
            ripple.style.opacity = "0";
            setTimeout(() => ripple.remove(), 300);
          }
          openEventModal(index);
          if (navigator.vibrate) navigator.vibrate(50);
        }, 800);
      }

      function handlePointerUp(e) {
        if (!currentCell) return;
        const cell = e.target.closest(".grid-cell");
        const index = parseInt(currentCell.dataset.index, 10);
        clearTimeout(longPressTimer);
        currentCell.classList.remove("long-pressing");

        // 移除所有視覺提示元素
        const ripples = currentCell.querySelectorAll(".bg-primary-300");
        ripples.forEach((r) => r.remove());

        // 添加點擊粒子效果
        createParticles(e.clientX, e.clientY);

        if (!isLongPress) handleQuickMark(index, currentCell);
        currentCell = null;
      }

      // 創建粒子效果
      function createParticles(x, y) {
        const colors = ["#3da35d", "#eab308", "#ec4899", "#6366f1", "#ef4444"];
        const particlesCount = 15;

        for (let i = 0; i < particlesCount; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";

          // 隨機大小
          const size = Math.floor(Math.random() * 8) + 4;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;

          // 隨機顏色
          particle.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];

          // 初始位置
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;

          // 隨機方向和距離
          const angle = Math.random() * Math.PI * 2;
          const distance = Math.random() * 80 + 20;
          const velocityX = Math.cos(angle) * distance;
          const velocityY = Math.sin(angle) * distance;

          // 設定動畫
          particle.style.transform = `translate(${velocityX}px, ${velocityY}px)`;

          document.body.appendChild(particle);

          // 移除粒子
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 1000);
        }
      }

      function cancelLongPress() {
        clearTimeout(longPressTimer);
        if (currentCell) {
          currentCell.classList.remove("long-pressing");
          // 移除所有視覺提示元素
          const ripples = currentCell.querySelectorAll(".bg-primary-300");
          ripples.forEach((r) => r.remove());
        }
        currentCell = null;
      }

      function handleQuickMark(index, cell) {
        if (filledDates.has(index)) {
          clearCell(cell);
          filledDates.delete(index);
        } else {
          const today = new Date();
          const data = {
            date: toLocalDateStr(today),
            displayDate: `${today.getMonth() + 1}/${today.getDate()}`,
            mood: "burnout", // 預設為身心俱疲
            description: "",
            timestamp: today.toISOString(),
            fontStyle:
              handwriteFonts[Math.floor(Math.random() * handwriteFonts.length)],
            annoyanceIndex: 0,
          };
          fillCell(cell, data);
          filledDates.set(index, data);
          animateCell(cell);
          showRandomQuote();

          // 檢查是否集滿100點
          if (filledDates.size === TOTAL_CELLS) {
            setTimeout(() => createFireworks(), 500);
            unlockAchievement("complete_all");
          }

          // 檢查成就
          checkAchievements();
        }
        saveData();
        updateAllStats();
      }

      function animateCell(cell) {
        cell.classList.add("animate-pop");
        setTimeout(() => cell.classList.remove("animate-pop"), 500);
      }

      function fillCell(cell, data) {
        const moodColors = {
          money: "#eab308", // 黃色
          burnout: "#ef4444", // 紅色
          annoying: "#6366f1", // 藍紫色
          stuck: "#737373", // 灰色
        };

        const color = moodColors[data.mood] || "#ef4444"; // 默認紅色

        cell.style.backgroundColor = color;
        cell.style.color = "white";
        cell.classList.add("filled", data.fontStyle);
        cell.innerHTML = `<span>${data.displayDate}</span>`;
        cell.setAttribute("data-filled", "true");
        cell.setAttribute("data-date", data.date);
        cell.setAttribute("data-mood", data.mood);
        cell.setAttribute("data-description", data.description || "");
        cell.setAttribute("data-timestamp", data.timestamp);
        cell.setAttribute("data-annoyance", data.annoyanceIndex || 0);
      }

      function clearCell(cell) {
        cell.style.backgroundColor = "";
        cell.style.color = "";
        cell.classList.remove("filled");
        cell.classList.remove(...handwriteFonts);
        cell.innerHTML = "";
        cell.removeAttribute("data-filled");
        cell.removeAttribute("data-date");
        cell.removeAttribute("data-mood");
        cell.removeAttribute("data-description");
        cell.removeAttribute("data-timestamp");
        cell.removeAttribute("data-annoyance");
      }

      // 煙火特效
      function createFireworks() {
        const colors = [
          "#ff0000",
          "#00ff00",
          "#0000ff",
          "#ffff00",
          "#ff00ff",
          "#00ffff",
          "#ffffff",
        ];
        const fireworksCount = 5;

        for (let i = 0; i < fireworksCount; i++) {
          setTimeout(() => {
            const firework = document.createElement("div");
            firework.className = "firework";
            firework.style.backgroundColor =
              colors[Math.floor(Math.random() * colors.length)];
            firework.style.left = `${Math.random() * 80 + 10}%`;

            document.body.appendChild(firework);

            setTimeout(() => {
              const explosion = document.createElement("div");
              explosion.className = "explosion";
              explosion.style.top = firework.getBoundingClientRect().top + "px";
              explosion.style.left =
                firework.getBoundingClientRect().left + "px";
              document.body.appendChild(explosion);

              // 煙火粒子
              createFireworkParticles(
                explosion.getBoundingClientRect().left,
                explosion.getBoundingClientRect().top
              );

              setTimeout(() => {
                if (firework.parentNode)
                  firework.parentNode.removeChild(firework);
                if (explosion.parentNode)
                  explosion.parentNode.removeChild(explosion);
              }, 1500);
            }, 1000);
          }, i * 300);
        }
      }

      function createFireworkParticles(x, y) {
        const colors = [
          "#ff0000",
          "#ffa500",
          "#ffff00",
          "#00ff00",
          "#0000ff",
          "#4b0082",
          "#ee82ee",
        ];
        const particlesCount = 30;

        for (let i = 0; i < particlesCount; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";

          // 隨機大小
          const size = Math.floor(Math.random() * 6) + 2;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;

          // 隨機顏色
          particle.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];

          // 初始位置
          particle.style.left = `${x}px`;
          particle.style.top = `${y}px`;

          // 隨機方向和距離
          const angle = Math.random() * Math.PI * 2;
          const distance = Math.random() * 150 + 50;
          const velocityX = Math.cos(angle) * distance;
          const velocityY = Math.sin(angle) * distance;

          // 設定動畫
          particle.style.transform = `translate(${velocityX}px, ${velocityY}px)`;

          document.body.appendChild(particle);

          // 移除粒子
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 1500);
        }
      }

      // --- 事件模態窗 ---
      function openEventModal(index) {
        const modal = document.getElementById("eventModal");
        modal.dataset.currentIndex = index;
        const data = filledDates.get(index);
        document.getElementById("eventDate").value = data
          ? data.date
          : toLocalDateStr(new Date());
        document.getElementById("eventDescription").value = data
          ? data.description || ""
          : "";
        setMood(data ? data.mood : "money");
        modal.classList.remove("hidden");
        modal.classList.add("flex", "modal-open");
      }
      function closeEventModal() {
        document.getElementById("eventModal").classList.remove("modal-open");
        setTimeout(
          () => document.getElementById("eventModal").classList.add("hidden"),
          300
        );
      }
      function renderMoodIcons() {
        const container = document.getElementById("moodSelector");
        if (!container) return;
        
        container.innerHTML = `
          <div class="mood-option" data-mood="money">
            <i class="fas fa-coins text-yellow-500"></i>
            <span>錢途茫茫</span>
          </div>
          <div class="mood-option" data-mood="burnout">
            <i class="fas fa-tired text-red-500"></i>
            <span>身心俱疲</span>
          </div>
          <div class="mood-option" data-mood="annoying">
            <i class="fas fa-angry text-indigo-500"></i>
            <span>鳥事一堆</span>
          </div>
          <div class="mood-option" data-mood="stuck">
            <i class="fas fa-minus-circle text-gray-500"></i>
            <span>缺乏成長</span>
          </div>
        `;
        
        // 添加點擊事件
        document.querySelectorAll(".mood-option").forEach(option => {
          option.addEventListener("click", () => {
            document.querySelectorAll(".mood-option").forEach(el => 
              el.classList.remove("selected"));
            option.classList.add("selected");
            document.getElementById("selectedMood").value = option.dataset.mood;
          });
        });
      }
      function setMood(mood) {
        document.querySelectorAll(".mood-btn").forEach((btn) => {
          const isSelected = btn.dataset.mood === mood;
          btn.classList.toggle("selected", isSelected);
        });
      }

      function saveEvent() {
        const modal = document.getElementById("eventModal");
        const index = parseInt(modal.dataset.currentIndex, 10);
        if (isNaN(index)) {
          console.error("Save failed: Invalid index.");
          return;
        }
        
        // 檢查是否選擇了心情
        const selectedMood = document.getElementById("selectedMood").value;
        if (!selectedMood) {
          // 顯示紅色框框提示，不使用系統提示窗
          const moodSelector = document.getElementById("moodSelector");
          moodSelector.classList.add("mood-error");
          document.getElementById("mood-error-message").classList.remove("hidden");
          return;
        }
        
        // 移除錯誤提示
        document.getElementById("moodSelector").classList.remove("mood-error");
        document.getElementById("mood-error-message").classList.add("hidden");
        
        const description = document.getElementById("eventDescription").value.trim();
        const score = calculateAnnoyanceIndex(description);
        if (score > 0) showAnnoyanceFeedback(score);
        
        const dateInput = document.getElementById("eventDate").value;
        const data = {
          date: dateInput,
          displayDate: `${new Date(dateInput).getMonth() + 1}/${new Date(dateInput).getDate()}`,
          mood: selectedMood,
          description,
          timestamp: new Date().toISOString(),
          fontStyle: filledDates.get(index)?.fontStyle || handwriteFonts[Math.floor(Math.random() * handwriteFonts.length)],
          annoyanceIndex: score,
        };
        
        const cell = document.querySelector(`[data-index="${index}"]`);
        fillCell(cell, data);
        filledDates.set(index, data);
        saveData();
        updateAllStats();
        checkAchievements(); // 檢查是否解鎖成就
        closeModal('eventModal');
      }

      function handleCellClick(index, cell) {
        if (isLongPress) {
          isLongPress = false;
          return;
        }
        
        // 如果已填充，顯示詳情
        if (filledDates.has(index)) {
          const data = filledDates.get(index);
          alert(`日期: ${data.date}\n心情: ${getMoodName(data.mood)}\n描述: ${data.description || "(無描述)"}\n厭世指數: ${data.annoyanceIndex || 0}`);
          return;
        }
        
        // 否則打開編輯模態窗
        const modal = document.getElementById("eventModal");
        modal.dataset.currentIndex = index;
        
        // 設置今天日期
        const today = new Date();
        const dateStr = toLocalDateStr(today);
        document.getElementById("eventDate").value = dateStr;
        
        // 清空表單
        document.getElementById("selectedMood").value = "";
        document.getElementById("eventDescription").value = "";
        document.querySelectorAll(".mood-option").forEach(el => el.classList.remove("selected"));
        
        openModal("eventModal");
      }
      
      function getMoodName(mood) {
        const moodNames = {
          money: "錢途茫茫",
          burnout: "身心俱疲",
          annoying: "鳥事一堆",
          stuck: "缺乏成長"
        };
        return moodNames[mood] || mood;
      }

      function startLongPress(e, index, cell) {
        if (longPressTimer) clearTimeout(longPressTimer);
        isLongPress = false;
        currentCell = cell;
        
        longPressTimer = setTimeout(() => {
          isLongPress = true;
          handleQuickMark(index, cell);
          
          // 添加漣漪效果
          const ripple = document.createElement("span");
          ripple.className = "ripple";
          cell.appendChild(ripple);
          
          // 移除漣漪效果
          setTimeout(() => {
            if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
          }, 1000);
        }, 500);
      }
      
      function endLongPress() {
        if (longPressTimer) clearTimeout(longPressTimer);
      }

      function updateAnnoyanceStats() {
        let total = 0;
        const counts = new Map();
        const allWords = new Map(); // 用於關鍵字雲
        
        filledDates.forEach((d) => {
          total += d.annoyanceIndex || 0;
          if (d.description) {
            // 分析每個字詞是否在厭世關鍵字庫中
            const words = d.description.toLowerCase().split(/\s+/);
            words.forEach((word) => {
              if (word.length >= 2) { // 忽略單字符
                // 更新所有字詞頻率 (關鍵字雲用)
                allWords.set(word, (allWords.get(word) || 0) + 1);
                
                // 更新厭世關鍵字頻率
                if (annoyanceKeywords.has(word)) {
                  counts.set(word, (counts.get(word) || 0) + 1);
                }
              }
            });
            
            // 分析多字詞關鍵字
            Array.from(annoyanceKeywords.keys()).forEach((keyword) => {
              if (keyword.includes(" ") && d.description.toLowerCase().includes(keyword)) {
                counts.set(keyword, (counts.get(keyword) || 0) + 1);
              }
            });
          }
        });
        
        document.getElementById("annoyanceIndexTotal").textContent = total;
        document.getElementById("annoyanceLevel").textContent =
          total > 200 ? "地獄級厭世" :
          total > 100 ? "重度厭世" :
          total > 50 ? "中度厭世" : "輕度厭世";
        
        // 更新厭世來源列表 - 分頁式顯示
        const allKeywords = Array.from(counts.entries())
          .sort((a, b) => b[1] - a[1]);
        
        const keywordsContainer = document.getElementById("topAnnoyanceKeywords");
        const paginationContainer = document.getElementById("keywordsPagination");
        
        if (allKeywords.length > 0) {
          renderKeywordsPage(keywordsContainer, allKeywords, 0);
          renderKeywordsPagination(paginationContainer, allKeywords);
        } else {
          keywordsContainer.innerHTML = `<div class="text-center py-4 text-neutral-500">尚無數據</div>`;
          paginationContainer.innerHTML = '';
        }
        
        // 生成關鍵字雲
        generateKeywordCloud(allWords);
      }
      
      function renderKeywordsPage(container, keywords, page) {
        const itemsPerPage = 15; // 每頁顯示15個關鍵字
        const startIndex = page * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, keywords.length);
        const pageKeywords = keywords.slice(startIndex, endIndex);
        
        container.innerHTML = '';
        
        if (pageKeywords.length === 0) {
          container.innerHTML = `<div class="text-center py-4 text-neutral-500">尚無數據</div>`;
          return;
        }
        
        // 創建3列5行的網格
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-3 gap-2';
        
        pageKeywords.forEach(([keyword, count]) => {
          const item = document.createElement('div');
          item.className = 'bg-white/50 rounded-lg p-2 flex justify-between items-center';
          item.innerHTML = `
            <span class="text-xs text-neutral-700 truncate flex-1">${keyword}</span>
            <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-medium">${count}</span>
          `;
          grid.appendChild(item);
        });
        
        container.appendChild(grid);
      }
      
      function renderKeywordsPagination(container, keywords) {
        const itemsPerPage = 15;
        const pageCount = Math.ceil(keywords.length / itemsPerPage);
        
        if (pageCount <= 1) {
          container.innerHTML = '';
          return;
        }
        
        container.innerHTML = '';
        
        for (let i = 0; i < pageCount; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = 'w-8 h-8 rounded-full bg-neutral-200 hover:bg-neutral-300 mx-1';
          pageBtn.textContent = i + 1;
          pageBtn.onclick = () => {
            // 移除所有活躍狀態
            document.querySelectorAll('#keywordsPagination button').forEach(btn => {
              btn.classList.remove('bg-accent-500', 'text-white');
              btn.classList.add('bg-neutral-200');
            });
            
            // 設置當前頁為活躍狀態
            pageBtn.classList.remove('bg-neutral-200');
            pageBtn.classList.add('bg-accent-500', 'text-white');
            
            // 渲染對應頁面
            renderKeywordsPage(document.getElementById('topAnnoyanceKeywords'), keywords, i);
          };
          
          // 設置第一頁為默認活躍狀態
          if (i === 0) {
            pageBtn.classList.remove('bg-neutral-200');
            pageBtn.classList.add('bg-accent-500', 'text-white');
          }
          
          container.appendChild(pageBtn);
        }
      }

      function loadPresets() {
        try {
          const savedPresets = localStorage.getItem(PRESETS_KEY);
          if (savedPresets) {
            customPresets = JSON.parse(savedPresets);
          } else {
            // 預設標籤
            customPresets = ["加班", "開不完的會議", "突發任務", "無意義的報告", "主管亂來"];
            savePresets();
          }
        } catch (e) {
          console.error("載入預設標籤失敗:", e);
          customPresets = ["加班", "開不完的會議", "突發任務", "無意義的報告", "主管亂來"];
        }
      }
      
      function savePresets() {
        try {
          localStorage.setItem(PRESETS_KEY, JSON.stringify(customPresets));
        } catch (e) {
          console.error("儲存預設標籤失敗:", e);
        }
      }

      // 註冊 Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(registration => {
              console.log('SW registered: ', registration);
            })
            .catch(error => {
              console.log('SW registration failed: ', error);
            });
        });
      }

      function loadAchievements() {
        try {
          const savedAchievements = localStorage.getItem(ACHIEVEMENTS_KEY);
          if (savedAchievements) {
            achievements = new Map(JSON.parse(savedAchievements));
          }
        } catch (e) {
          console.error("載入成就失敗:", e);
          achievements = new Map();
        }
      }
      
      function saveAchievements() {
        try {
          localStorage.setItem(ACHIEVEMENTS_KEY, JSON.stringify(Array.from(achievements.entries())));
        } catch (e) {
          console.error("儲存成就失敗:", e);
        }
      }
      
      function unlockAchievement(id) {
        if (achievements.has(id)) return; // 已解鎖
        
        const achievementData = {
          id,
          unlockedAt: new Date().toISOString()
        };
        
        achievements.set(id, achievementData);
        saveAchievements();
        
        // 顯示成就通知
        showAchievementNotification(id);
      }
      
      function showAchievementNotification(id) {
        const achievementInfo = getAchievementInfo(id);
        if (!achievementInfo) return;
        
        const notification = document.createElement('div');
        notification.className = 'achievement-notification';
        notification.innerHTML = `
          <div class="achievement-notification-icon">🏆</div>
          <div class="achievement-notification-content">
            <h4>成就解鎖！</h4>
            <p>${achievementInfo.title}</p>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        // 5秒後自動移除
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 5000);
      }
      
      function getAchievementInfo(id) {
        const achievementsInfo = {
          "first_record": {
            title: "初次紀錄",
            description: "記錄第一個厭世事件",
            icon: "fa-pencil-alt",
            color: "#3b82f6"
          },
          "first_burnout": {
            title: "身心俱疲",
            description: "第一次記錄身心俱疲",
            icon: "fa-tired",
            color: "#ef4444"
          },
          "first_money": {
            title: "錢途茫茫",
            description: "第一次記錄錢途茫茫",
            icon: "fa-coins",
            color: "#eab308"
          },
          "first_annoying": {
            title: "鳥事一堆",
            description: "第一次記錄鳥事一堆",
            icon: "fa-angry",
            color: "#6366f1"
          },
          "first_stuck": {
            title: "缺乏成長",
            description: "第一次記錄缺乏成長",
            icon: "fa-minus-circle",
            color: "#737373"
          },
          "high_annoyance": {
            title: "極度厭世",
            description: "單次厭世指數超過 15 分",
            icon: "fa-fire",
            color: "#dc2626"
          },
          "collector": {
            title: "收集控",
            description: "收集超過 30 個厭世點數",
            icon: "fa-trophy",
            color: "#8b5cf6"
          },
          "half_way": {
            title: "半路離職",
            description: "收集超過 50 個厭世點數",
            icon: "fa-flag-checkered",
            color: "#f59e0b"
          },
          "almost_there": {
            title: "即將解脫",
            description: "收集超過 90 個厭世點數",
            icon: "fa-door-open",
            color: "#10b981"
          },
          "complete_all": {
            title: "社畜解放",
            description: "收集滿 100 個厭世點數",
            icon: "fa-crown",
            color: "#f97316"
          }
        };
        
        return achievementsInfo[id];
      }
      
      function checkAchievements() {
        const filledCount = filledDates.size;
        
        // 檢查首次記錄
        if (filledCount > 0) {
          unlockAchievement("first_record");
        }
        
        // 檢查收集相關成就
        if (filledCount >= 30) unlockAchievement("collector");
        if (filledCount >= 50) unlockAchievement("half_way");
        if (filledCount >= 90) unlockAchievement("almost_there");
        if (filledCount >= 100) unlockAchievement("complete_all");
        
        // 檢查各種心情類型
        let hasMoney = false;
        let hasBurnout = false;
        let hasAnnoying = false;
        let hasStuck = false;
        let highAnnoyance = false;
        
        filledDates.forEach(data => {
          if (data.mood === "money") hasMoney = true;
          if (data.mood === "burnout") hasBurnout = true;
          if (data.mood === "annoying") hasAnnoying = true;
          if (data.mood === "stuck") hasStuck = true;
          if (data.annoyanceIndex && data.annoyanceIndex >= 15) highAnnoyance = true;
        });
        
        if (hasMoney) unlockAchievement("first_money");
        if (hasBurnout) unlockAchievement("first_burnout");
        if (hasAnnoying) unlockAchievement("first_annoying");
        if (hasStuck) unlockAchievement("first_stuck");
        if (highAnnoyance) unlockAchievement("high_annoyance");
      }
      
      function renderAchievements() {
        const container = document.getElementById("achievementsList");
        if (!container) return;
        
        container.innerHTML = "";
        
        // 獲取所有成就信息
        const allAchievements = [
          "first_record", "first_money", "first_burnout", 
          "first_annoying", "first_stuck", "high_annoyance",
          "collector", "half_way", "almost_there", "complete_all"
        ];
        
        allAchievements.forEach(id => {
          const info = getAchievementInfo(id);
          const isUnlocked = achievements.has(id);
          const unlockedData = isUnlocked ? achievements.get(id) : null;
          
          const achievementEl = document.createElement("div");
          achievementEl.className = `achievement ${isUnlocked ? "" : "achievement-locked"}`;
          
          achievementEl.innerHTML = `
            <div class="achievement-icon" style="background-color: ${info.color}">
              <i class="fas ${info.icon}"></i>
            </div>
            <div class="achievement-content">
              <div class="achievement-title">${info.title}</div>
              <div class="achievement-description">${info.description}</div>
              ${isUnlocked ? `<div class="achievement-unlocked-date">解鎖於 ${new Date(unlockedData.unlockedAt).toLocaleDateString()}</div>` : ""}
            </div>
          `;
          
          container.appendChild(achievementEl);
        });
      }

      function setupListeners() {
        document
          .getElementById("shareBtnTrigger")
          .addEventListener("click", () => openModal("shareModal"));
      }

      function setupRipple() {
        // 添加漣漪效果
        document.addEventListener('click', function(e) {
          if (e.target.closest('.grid-cell')) {
            const cell = e.target.closest('.grid-cell');
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            cell.appendChild(ripple);
            
            setTimeout(() => {
              if (ripple.parentNode) ripple.parentNode.removeChild(ripple);
            }, 1000);
          }
        });
      }
      
      function setupPWA() {
        checkAndShowPwaPrompt();
      }
      
      function updateAllStats() {
        const filledCount = filledDates.size;
        document.getElementById("filledCount").textContent = filledCount;
        document.getElementById("completionRate").textContent = `${Math.round(
          (filledCount / TOTAL_CELLS) * 100
        )}%`;
        
        // 更新進度環
        const progressCircle = document.getElementById("progressCircle");
        const circumference = 2 * Math.PI * 54; // 圓的周長
        const offset = circumference - (filledCount / TOTAL_CELLS) * circumference;
        progressCircle.style.strokeDasharray = `${circumference - offset} ${offset}`;
        
        // 更新各種心情數量
        let moodMoney = 0;
        let moodBurnout = 0;
        let moodAnnoying = 0;
        let moodStuck = 0;
        
        filledDates.forEach((data) => {
          if (data.mood === "money") moodMoney++;
          else if (data.mood === "burnout") moodBurnout++;
          else if (data.mood === "annoying") moodAnnoying++;
          else if (data.mood === "stuck") moodStuck++;
        });
        
        document.getElementById("moodMoneyCount").textContent = moodMoney;
        document.getElementById("moodBurnoutCount").textContent = moodBurnout;
        document.getElementById("moodAnnoyingCount").textContent = moodAnnoying;
        document.getElementById("moodStuckCount").textContent = moodStuck;
        
        // 更新圖表
        if (dailyChart) updateChart();
        
        // 更新厭世指數統計
        updateAnnoyanceStats();
        
        // 更新近期記錄
        updateRecentRecords();
      }

      function updateChart() {
        if (!dailyChart) return;
        
        // 獲取最近 30 天的數據
        const today = new Date();
        const dates = [];
        const datasets = [
          { label: "錢途茫茫", data: [], backgroundColor: "#eab308" },
          { label: "身心俱疲", data: [], backgroundColor: "#ef4444" },
          { label: "鳥事一堆", data: [], backgroundColor: "#6366f1" },
          { label: "缺乏成長", data: [], backgroundColor: "#737373" },
        ];
        
        // 生成最近 30 天的日期
        for (let i = 29; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          dates.push(d.toLocaleDateString("zh-TW", { month: "short", day: "numeric" }));
          
          // 初始化每天的數據為 0
          datasets.forEach(ds => ds.data.push(0));
        }
        
        // 計算每天的心情數量
        filledDates.forEach(data => {
          const recordDate = new Date(data.date);
          const diffTime = today.getTime() - recordDate.getTime();
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays <= 29) {
            const index = 29 - diffDays;
            
            if (data.mood === "money") datasets[0].data[index]++;
            else if (data.mood === "burnout") datasets[1].data[index]++;
            else if (data.mood === "annoying") datasets[2].data[index]++;
            else if (data.mood === "stuck") datasets[3].data[index]++;
          }
        });
        
        // 更新圖表數據
        dailyChart.data.labels = dates;
        dailyChart.data.datasets = datasets;
        dailyChart.update();
      }
      
      function updateRecentRecords() {
        const container = document.getElementById("recentRecords");
        if (!container) return;
        
        // 獲取最近的記錄
        const records = Array.from(filledDates.entries())
          .map(([index, data]) => ({ index, ...data }))
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          .slice(0, 5);
        
        if (records.length === 0) {
          container.innerHTML = `
            <p class="text-neutral-500 text-center py-8">
              <i class="fas fa-inbox text-3xl mb-2 block"></i>尚無記錄
            </p>
          `;
          return;
        }
        
        container.innerHTML = "";
        
        records.forEach(record => {
          const date = new Date(record.date);
          const formattedDate = date.toLocaleDateString("zh-TW", {
            year: "numeric",
            month: "long",
            day: "numeric",
            weekday: "short"
          });
          
          const moodEmoji = {
            money: '<i class="fas fa-coins text-yellow-500"></i>',
            burnout: '<i class="fas fa-tired text-red-500"></i>',
            annoying: '<i class="fas fa-angry text-indigo-500"></i>',
            stuck: '<i class="fas fa-minus-circle text-gray-500"></i>'
          };
          
          const moodNames = {
            money: "錢途茫茫",
            burnout: "身心俱疲",
            annoying: "鳥事一堆",
            stuck: "缺乏成長"
          };
          
          const recordEl = document.createElement("div");
          recordEl.className = "bg-white/50 rounded-lg p-3 shadow-sm";
          recordEl.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <div class="text-sm font-semibold text-neutral-700">${formattedDate}</div>
              <div class="text-xs text-neutral-500">#${record.index + 1}</div>
            </div>
            <div class="flex items-center gap-2">
              ${moodEmoji[record.mood]}
              <span class="text-sm">${moodNames[record.mood]}</span>
            </div>
            ${record.description ? `<p class="text-xs text-neutral-600 mt-1">${record.description}</p>` : ''}
          `;
          
          container.appendChild(recordEl);
        });
      }
      
      function initChart() {
        const ctx = document.getElementById("dailyChart").getContext("2d");
        dailyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: [],
            datasets: []
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
                labels: {
                  boxWidth: 12,
                  usePointStyle: true,
                  pointStyle: "circle"
                }
              },
              tooltip: {
                mode: "index",
                intersect: false
              }
            },
            scales: {
              x: {
                stacked: true,
                grid: {
                  display: false
                }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      function generateKeywordCloud(words) {
        const container = document.getElementById("keywordCloud");
        if (!container) return;
        
        // 只取出現頻率最高的前 20 個詞
        const topWords = Array.from(words.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 20);
        
        if (topWords.length < 5) {
          container.innerHTML = `<p class="text-neutral-500 text-center">尚無足夠數據生成關鍵字雲</p>`;
          return;
        }
        
        container.innerHTML = "";
        
        // 找出最高頻率，用於計算字體大小
        const maxCount = topWords[0][1];
        
        topWords.forEach(([word, count]) => {
          // 計算相對大小 (1-5)
          const size = 1 + Math.floor((count / maxCount) * 4);
          const fontSize = 0.7 + (size * 0.15); // 0.85 - 1.45rem
          
          // 隨機顏色
          const colors = ["#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];
          const color = colors[Math.floor(Math.random() * colors.length)];
          
          const wordSpan = document.createElement("span");
          wordSpan.className = "inline-block m-1 px-2 py-1 rounded-lg";
          wordSpan.style.fontSize = `${fontSize}rem`;
          wordSpan.style.color = color;
          wordSpan.style.backgroundColor = `${color}10`;
          wordSpan.style.border = `1px solid ${color}30`;
          wordSpan.textContent = word;
          
          container.appendChild(wordSpan);
        });
      }
      
      function calculateAnnoyanceIndex(text) {
        if (!text) return 0;
        
        let score = 0;
        const lowerText = text.toLowerCase();
        
        // 檢查每個關鍵字
        annoyanceKeywords.forEach((value, keyword) => {
          if (lowerText.includes(keyword.toLowerCase())) {
            score += value;
          }
        });
        
        // 檢查句子長度和標點符號
        const exclamationCount = (text.match(/!/g) || []).length;
        score += exclamationCount * 0.5;
        
        // 檢查全大寫單詞 (表示憤怒)
        const upperCaseWords = text.match(/\b[A-Z]{3,}\b/g) || [];
        score += upperCaseWords.length * 1.5;
        
        return Math.round(score);
      }
      
      function showAnnoyanceFeedback(score) {
        const feedback = document.getElementById("annoyanceFeedback");
        feedback.textContent = `+${score}`;
        feedback.classList.remove("hidden");
        
        // 重置動畫
        feedback.style.animation = 'none';
        feedback.offsetHeight; // 觸發重繪
        feedback.style.animation = 'feedbackPop 2s ease-out forwards';
        
        // 5秒後隱藏
        setTimeout(() => {
          feedback.classList.add("hidden");
        }, 2000);
      }
      
      function showRandomQuote() {
        const quotes = [
          "人生太短暫，別浪費在不喜歡的地方。",
          "離職不是結束，而是新生活的開始。",
          "如果你不喜歡現在的工作，那就離開吧，世界很大。",
          "每一次的離職，都是為了更好的相遇。",
          "當工作不再帶給你快樂，離開是最好的選擇。",
          "勇敢說不，為自己的人生負責。",
          "離職是一種勇氣，也是一種智慧。",
          "不要害怕改變，最糟糕的是一成不變的生活。",
          "生命太過短暫，不要浪費在委屈上。",
          "你的價值遠不止於此，去尋找真正欣賞你的地方。",
        ];
        
        const quoteDisplay = document.getElementById("quoteDisplay");
        const quoteText = document.getElementById("quoteText");
        
        // 隨機選擇一句話
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
        quoteText.textContent = randomQuote;
        
        // 顯示引言
        quoteDisplay.classList.remove("hidden");
        
        // 設置定時器，10秒後隱藏
        if (quoteTimer) clearTimeout(quoteTimer);
        quoteTimer = setTimeout(hideQuote, 10000);
      }
      
      function hideQuote() {
        document.getElementById("quoteDisplay").classList.add("hidden");
        if (quoteTimer) clearTimeout(quoteTimer);
      }
      
      function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add("show");
          
          // 如果是分享模態窗，設置分享內容
          if (modalId === "shareModal") {
            setupShareContent();
          } else if (modalId === "aiExportModal") {
            generateAIPrompt();
          }
        }
      }
      
      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove("show");
        }
      }
      
      function setupShareContent() {
        const filledCount = filledDates.size;
        const shareText = `我已在「離職集點卡」集滿 ${filledCount}/100 點！厭世指數：${document.getElementById("annoyanceIndexTotal").textContent}，離職進度：${Math.round((filledCount / TOTAL_CELLS) * 100)}%。一起來記錄職場心情吧！`;
        
        document.getElementById("shareAnnoyanceIndex").textContent = `厭世指數：${document.getElementById("annoyanceIndexTotal").textContent}`;
        
        // 設置複製按鈕
        document.getElementById("copyLinkBtn").onclick = () => {
          navigator.clipboard.writeText(shareText)
            .then(() => {
              alert("已複製到剪貼簿！");
            })
            .catch(err => {
              console.error('無法複製: ', err);
            });
        };
        
        // 設置社交媒體分享
        document.getElementById("shareToTwitterBtn").onclick = () => {
          window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`);
        };
        
        document.getElementById("shareToLineBtn").onclick = () => {
          window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(shareText)}`);
        };
        
        document.getElementById("shareToThreadsBtn").onclick = () => {
          // Threads 目前沒有官方分享 API，所以只能複製文本
          navigator.clipboard.writeText(shareText)
            .then(() => {
              alert("已複製到剪貼簿！請手動貼到 Threads。");
            })
            .catch(err => {
              console.error('無法複製: ', err);
            });
        };
      }
      
      function generateAIPrompt() {
        const filledCount = filledDates.size;
        const annoyanceIndex = document.getElementById("annoyanceIndexTotal").textContent;
        
        // 收集心情統計
        const moodMoney = document.getElementById("moodMoneyCount").textContent;
        const moodBurnout = document.getElementById("moodBurnoutCount").textContent;
        const moodAnnoying = document.getElementById("moodAnnoyingCount").textContent;
        const moodStuck = document.getElementById("moodStuckCount").textContent;
        
        // 收集最近的記錄
        const recentRecords = Array.from(filledDates.entries())
          .map(([index, data]) => ({ index, ...data }))
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
          .slice(0, 10)
          .map(record => {
            const moodNames = {
              money: "錢途茫茫",
              burnout: "身心俱疲",
              annoying: "鳥事一堆",
              stuck: "缺乏成長"
            };
            return `- ${record.date} (${moodNames[record.mood]}): ${record.description || "無描述"}`;
          })
          .join("\n");
        
        // 生成 AI Prompt
        const prompt = `# 職場厭世分析請求

我在使用「離職集點卡」記錄我的職場心情，目前已收集了 ${filledCount}/100 點，總厭世指數為 ${annoyanceIndex}。

## 心情分類統計
- 錢途茫茫: ${moodMoney} 次
- 身心俱疲: ${moodBurnout} 次
- 鳥事一堆: ${moodAnnoying} 次
- 缺乏成長: ${moodStuck} 次

## 最近的記錄
${recentRecords}

請根據以上資料，幫我分析：
1. 我目前的職場壓力程度如何？
2. 我最主要的職場困擾是什麼？
3. 我是否應該考慮尋找新工作？
4. 有哪些建議可以改善我目前的職場狀況？
5. 如果我決定離職，應該如何準備？

謝謝你的分析與建議！`;

        document.getElementById("ai-prompt-output").value = prompt;
        
        // 設置複製按鈕
        document.getElementById("copyAIPromptBtn").onclick = () => {
          const promptText = document.getElementById("ai-prompt-output");
          promptText.select();
          navigator.clipboard.writeText(promptText.value)
            .then(() => {
              alert("已複製到剪貼簿！可直接貼到 ChatGPT 等 AI 工具中。");
            })
            .catch(err => {
              console.error('無法複製: ', err);
            });
        };
      }
      
      function showClearConfirm() {
        openModal("confirmModal");
      }
      
      function confirmClearAll() {
        filledDates.clear();
        saveData();
        generateGrid();
        updateAllStats();
        closeModal("confirmModal");
      }
      
      function addCustomPreset() {
        const input = document.getElementById("customPresetInput");
        const value = input.value.trim();
        
        if (value && !customPresets.includes(value)) {
          customPresets.push(value);
          savePresets();
          renderPresetButtons();
          input.value = "";
        }
      }
      
      function renderPresetButtons() {
        const container = document.getElementById("presetButtonsContainer");
        if (!container) return;
        
        container.innerHTML = "";
        
        customPresets.forEach((preset) => {
          const btn = document.createElement("button");
          btn.className = "bg-gray-100 hover:bg-gray-200 text-gray-800 text-xs px-3 py-1 rounded-full";
          btn.textContent = preset;
          btn.onclick = () => {
            const textarea = document.getElementById("eventDescription");
            textarea.value += (textarea.value ? " " : "") + preset;
          };
          
          container.appendChild(btn);
        });
      }
      
      function openEventModal(index) {
        const modal = document.getElementById("eventModal");
        modal.dataset.currentIndex = index;
        
        const data = filledDates.get(index);
        document.getElementById("eventDate").value = data
          ? data.date
          : toLocalDateStr(new Date());
        document.getElementById("eventDescription").value = data
          ? data.description || ""
          : "";
        
        // 設置心情
        document.getElementById("selectedMood").value = data ? data.mood : "";
        document.querySelectorAll(".mood-option").forEach(option => {
          option.classList.toggle("selected", option.dataset.mood === (data ? data.mood : ""));
        });
        
        // 移除錯誤提示
        document.getElementById("moodSelector").classList.remove("mood-error");
        document.getElementById("mood-error-message").classList.add("hidden");
        
        // 渲染預設按鈕
        renderPresetButtons();
        
        modal.classList.remove("hidden");
        modal.classList.add("flex", "modal-open");
      }
    </script>
</html>

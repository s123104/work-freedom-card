<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>成就系統測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-center">🏆 成就系統功能測試</h1>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 測試按鈕區域 -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-bold mb-4">測試操作</h2>
          <div class="space-y-3">
            <button
              onclick="testFirstFill()"
              class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600"
            >
              <i class="fas fa-play mr-2"></i>測試首次填寫
            </button>
            <button
              onclick="testMoneyMood()"
              class="w-full bg-yellow-500 text-white p-3 rounded-lg hover:bg-yellow-600"
            >
              <i class="fas fa-coins mr-2"></i>測試金錢心情
            </button>
            <button
              onclick="testBurnoutMood()"
              class="w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600"
            >
              <i class="fas fa-fire mr-2"></i>測試燃盡心情
            </button>
            <button
              onclick="testRainbowDay()"
              class="w-full bg-purple-500 text-white p-3 rounded-lg hover:bg-purple-600"
            >
              <i class="fas fa-rainbow mr-2"></i>測試彩虹日
            </button>
            <button
              onclick="clearTestData()"
              class="w-full bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600"
            >
              <i class="fas fa-trash mr-2"></i>清除測試數據
            </button>
          </div>
        </div>

        <!-- 結果顯示區域 -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
          <h2 class="text-xl font-bold mb-4">測試結果</h2>
          <div id="testResults" class="space-y-2 text-sm">
            <p class="text-gray-600">點擊左側按鈕開始測試...</p>
          </div>
        </div>
      </div>

      <!-- 成就顯示區域 -->
      <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-bold mb-4">當前成就狀態</h2>
        <div
          id="achievementsList"
          class="grid grid-cols-2 md:grid-cols-4 gap-4"
        >
          <!-- 成就將在這裡顯示 -->
        </div>
      </div>

      <!-- 統計數據 -->
      <div class="mt-8 bg-white p-6 rounded-lg shadow-lg">
        <h2 class="text-xl font-bold mb-4">統計數據</h2>
        <div id="statsDisplay" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <!-- 統計數據將在這裡顯示 -->
        </div>
      </div>
    </div>

    <script>
      // 模擬主應用的核心功能
      let filledDates = new Map();
      let achievements = new Map();

      const ACHIEVEMENT_DEFINITIONS = {
        firstStep: {
          name: "初次踏入",
          description: "完成第一個格子",
          icon: '<i class="fas fa-running text-green-500"></i>',
          condition: (stats) => stats.totalFilled >= 1,
          category: "入門",
          rarity: "common",
        },
        moneyMaster: {
          name: "賺錢狂魔",
          description: "連續5天選擇金錢心情",
          icon: '<i class="fas fa-coins text-yellow-500"></i>',
          condition: (stats) => stats.consecutiveMoney >= 5,
          category: "心情",
          rarity: "uncommon",
        },
        burnoutKing: {
          name: "燃燒殆盡",
          description: "單日燃盡心情達到10次",
          icon: '<i class="fas fa-fire text-red-500"></i>',
          condition: (stats) => stats.dailyBurnout >= 10,
          category: "心情",
          rarity: "rare",
        },
        rainbowCollector: {
          name: "彩虹收集者",
          description: "一天內體驗所有4種心情",
          icon: '<i class="ri-rainbow-line text-pink-500"></i>',
          condition: (stats) => stats.rainbowDay,
          category: "心情",
          rarity: "epic",
        },
      };

      function addTestResult(message, type = "info") {
        const results = document.getElementById("testResults");
        const colors = {
          info: "text-blue-600",
          success: "text-green-600",
          warning: "text-yellow-600",
          error: "text-red-600",
        };

        const p = document.createElement("p");
        p.className = colors[type] || colors.info;
        p.innerHTML = `<i class="fas fa-circle mr-2"></i>${message}`;
        results.appendChild(p);
        results.scrollTop = results.scrollHeight;
      }

      function testFirstFill() {
        addTestResult("開始測試首次填寫...", "info");

        // 模擬填寫第一個格子
        const today = new Date().toISOString().split("T")[0];
        filledDates.set(0, {
          date: today,
          mood: "money",
          description: "測試首次填寫",
          timestamp: new Date().toISOString(),
          annoyanceIndex: 5,
        });

        checkAchievements();
        updateDisplay();
        addTestResult("✅ 首次填寫測試完成", "success");
      }

      function testMoneyMood() {
        addTestResult("開始測試連續金錢心情...", "info");

        // 模擬連續5天金錢心情
        for (let i = 0; i < 5; i++) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];

          filledDates.set(i, {
            date: dateStr,
            mood: "money",
            description: `測試金錢心情第${i + 1}天`,
            timestamp: date.toISOString(),
            annoyanceIndex: 3,
          });
        }

        checkAchievements();
        updateDisplay();
        addTestResult("✅ 連續金錢心情測試完成", "success");
      }

      function testBurnoutMood() {
        addTestResult("開始測試燃盡心情...", "info");

        // 模擬單日10次燃盡心情
        const today = new Date().toISOString().split("T")[0];
        for (let i = 0; i < 10; i++) {
          filledDates.set(100 + i, {
            date: today,
            mood: "burnout",
            description: `測試燃盡心情第${i + 1}次`,
            timestamp: new Date().toISOString(),
            annoyanceIndex: 8,
          });
        }

        checkAchievements();
        updateDisplay();
        addTestResult("✅ 燃盡心情測試完成", "success");
      }

      function testRainbowDay() {
        addTestResult("開始測試彩虹日...", "info");

        // 模擬一天內所有4種心情
        const today = new Date().toISOString().split("T")[0];
        const moods = ["money", "burnout", "annoying", "stuck"];

        moods.forEach((mood, index) => {
          filledDates.set(200 + index, {
            date: today,
            mood: mood,
            description: `測試${mood}心情`,
            timestamp: new Date().toISOString(),
            annoyanceIndex: 5,
          });
        });

        checkAchievements();
        updateDisplay();
        addTestResult("✅ 彩虹日測試完成", "success");
      }

      function clearTestData() {
        filledDates.clear();
        achievements.clear();
        updateDisplay();
        document.getElementById("testResults").innerHTML =
          '<p class="text-gray-600">測試數據已清除</p>';
        addTestResult("🗑️ 測試數據已清除", "warning");
      }

      function calculateUserStats() {
        const today = new Date().toISOString().split("T")[0];
        const filledArray = Array.from(filledDates.values());

        return {
          totalFilled: filledDates.size,
          consecutiveMoney: calculateConsecutiveMood("money"),
          dailyBurnout: calculateDailyMoodCount("burnout", today),
          rainbowDay: checkRainbowDay(today),
        };
      }

      function calculateConsecutiveMood(mood) {
        const today = new Date();
        let consecutive = 0;

        for (let i = 0; i < 30; i++) {
          const checkDate = new Date(today);
          checkDate.setDate(today.getDate() - i);
          const dateStr = checkDate.toISOString().split("T")[0];

          let hasMood = false;
          filledDates.forEach((data) => {
            if (data.date === dateStr && data.mood === mood) {
              hasMood = true;
            }
          });

          if (hasMood) {
            consecutive++;
          } else {
            break;
          }
        }
        return consecutive;
      }

      function calculateDailyMoodCount(mood, date) {
        let count = 0;
        filledDates.forEach((data) => {
          if (data.date === date && data.mood === mood) {
            count++;
          }
        });
        return count;
      }

      function checkRainbowDay(date) {
        const moods = new Set();
        filledDates.forEach((data) => {
          if (data.date === date) {
            moods.add(data.mood);
          }
        });
        return moods.size >= 4;
      }

      function checkAchievements() {
        const stats = calculateUserStats();
        let newAchievements = [];

        Object.entries(ACHIEVEMENT_DEFINITIONS).forEach(
          ([key, achievement]) => {
            if (!achievements.has(key) && achievement.condition(stats)) {
              achievements.set(key, {
                ...achievement,
                unlockedAt: new Date().toISOString(),
                id: key,
              });
              newAchievements.push(achievement);
              addTestResult(`🎉 解鎖成就: ${achievement.name}`, "success");
            }
          }
        );
      }

      function updateDisplay() {
        updateAchievementsList();
        updateStatsDisplay();
      }

      function updateAchievementsList() {
        const container = document.getElementById("achievementsList");
        container.innerHTML = "";

        Object.entries(ACHIEVEMENT_DEFINITIONS).forEach(
          ([key, achievement]) => {
            const isUnlocked = achievements.has(key);
            const div = document.createElement("div");
            div.className = `p-4 rounded-lg border-2 text-center ${
              isUnlocked
                ? "bg-green-50 border-green-200"
                : "bg-gray-50 border-gray-200 opacity-50"
            }`;

            div.innerHTML = `
                    <div class="text-2xl mb-2">${achievement.icon}</div>
                    <div class="font-bold text-sm">${achievement.name}</div>
                    <div class="text-xs text-gray-600 mt-1">${
                      achievement.description
                    }</div>
                    <div class="text-xs mt-2 ${
                      isUnlocked ? "text-green-600" : "text-gray-400"
                    }">
                        ${isUnlocked ? "✅ 已解鎖" : "🔒 未解鎖"}
                    </div>
                `;

            container.appendChild(div);
          }
        );
      }

      function updateStatsDisplay() {
        const stats = calculateUserStats();
        const container = document.getElementById("statsDisplay");

        container.innerHTML = `
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">${
                      stats.totalFilled
                    }</div>
                    <div class="text-sm text-blue-800">總填寫數</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-600">${
                      stats.consecutiveMoney
                    }</div>
                    <div class="text-sm text-yellow-800">連續金錢心情</div>
                </div>
                <div class="text-center p-4 bg-red-50 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">${
                      stats.dailyBurnout
                    }</div>
                    <div class="text-sm text-red-800">今日燃盡次數</div>
                </div>
                <div class="text-center p-4 bg-purple-50 rounded-lg">
                    <div class="text-2xl font-bold text-purple-600">${
                      stats.rainbowDay ? "是" : "否"
                    }</div>
                    <div class="text-sm text-purple-800">彩虹日</div>
                </div>
            `;
      }

      // 初始化顯示
      updateDisplay();
    </script>
  </body>
</html>
